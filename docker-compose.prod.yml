services:
  # 后端API服务
  backend:
    build:
      context: ./back
      dockerfile: Dockerfile
    container_name: yeepay-backend-prod
    expose:
      - "9000"  # 只暴露给内部网络，不直接对外
    environment:
      - ENVIRONMENT=production
      - HOST=0.0.0.0
      - PORT=9000
      - COMFYUI_URL=http://host.docker.internal:8188
      - COMFYUI_OUTPUT_DIR=/app/comfyui/output/yeepay
      - COMFYUI_MAIN_OUTPUT_DIR=/app/comfyui/output
      - COMFYUI_INPUT_DIR=/app/comfyui/input
      - COMFYUI_TIMEOUT=300
      - MAX_CONCURRENT_TASKS=3
      - CORS_ORIGINS=*
      - DEBUG=false
      - LOG_LEVEL=INFO
      - OLLAMA_URL=http://host.docker.internal:11434
      - ADMIN_BACKEND_URL=http://admin-backend:8888
      - REDIS_ENABLED=true
      - REDIS_URL=redis://redis:6379
    networks:
      - yeepay-network
    volumes:
      - yeepay-uploads-prod:/app/uploads
      - yeepay-outputs-prod:/app/outputs
      - yeepay-database-prod:/app/data
      - yeepay-logs-prod:/app/logs
      - E:/AI-Image/ComfyUI-aki-v1.4/output:/app/comfyui/output
      - E:/AI-Image/ComfyUI-aki-v1.4/output/yeepay:/app/comfyui/output/yeepay
      - E:/AI-Image/ComfyUI-aki-v1.4/input:/app/comfyui/input
      - E:/AI-Image/ComfyUI-aki-v1.4/models:/app/comfyui/models
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis 缓存服务
  redis:
    image: redis:alpine
    container_name: yeepay-redis-prod
    restart: unless-stopped
    volumes:
      - redis-data:/data
    networks:
      - yeepay-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.1'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    command: redis-server --maxmemory 400mb --maxmemory-policy allkeys-lru --save 900 1 --save 300 10

  # 前端服务已删除，静态文件由 Nginx 直接处理

  # Nginx 反向代理 - 统一入口（包含前端静态文件）
  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx
    container_name: yeepay-nginx-prod
    ports:
      - "80:80"      # HTTP
      - "443:443"    # HTTPS
    volumes:
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - yeepay-logs:/var/log/nginx
    depends_on:
      backend:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - yeepay-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
        reservations:
          memory: 64M
          cpus: '0.1'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  yeepay-network:
    driver: bridge

volumes:
  yeepay-uploads-prod:
  yeepay-outputs-prod:
  yeepay-database-prod:
  yeepay-logs-prod:
  yeepay-logs:
  redis-data:
