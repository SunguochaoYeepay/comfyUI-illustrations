<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flux Kontext å›¾åƒç”Ÿæˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 2px dashed #dee2e6;
        }

        .result-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            background-color: white;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: block;
            padding: 20px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-label:hover {
            background-color: #f8f9ff;
            border-color: #5a6fd8;
        }

        .preview-image {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 8px;
        }

        .advanced-params {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .advanced-params h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .param-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .generate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }

        .result-image {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .history-section {
            grid-column: 1 / -1;
            margin-top: 30px;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
        }

        .history-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .param-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ Flux Kontext å›¾åƒç”Ÿæˆ</h1>
            <p>åŸºäºå‚è€ƒå›¾åƒå’Œæ–‡æœ¬æè¿°ç”Ÿæˆé«˜è´¨é‡å›¾åƒ</p>
        </div>

        <div class="main-content">
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-section">
                <h2>ğŸ“ åˆ›å»ºæ–°å›¾åƒ</h2>
                
                <form id="generateForm">
                    <div class="form-group">
                        <label for="referenceImage">å‚è€ƒå›¾åƒ</label>
                        <div class="file-upload">
                            <input type="file" id="referenceImage" accept="image/*" required>
                            <label for="referenceImage" class="file-upload-label">
                                <div>ğŸ“ ç‚¹å‡»é€‰æ‹©å›¾åƒæ–‡ä»¶</div>
                                <small>æ”¯æŒ JPG, PNG, WebP æ ¼å¼</small>
                            </label>
                        </div>
                        <img id="imagePreview" class="preview-image" style="display: none;">
                    </div>

                    <div class="form-group">
                        <label for="description">æ–‡æœ¬æè¿°</label>
                        <textarea id="description" placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„å›¾åƒ..." required></textarea>
                    </div>

                    <div class="param-row">
                        <div class="form-group">
                            <label for="count">ç”Ÿæˆæ•°é‡</label>
                            <select id="count">
                                <option value="1">1å¼ </option>
                                <option value="2">2å¼ </option>
                                <option value="3">3å¼ </option>
                                <option value="4">4å¼ </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="size">å›¾åƒå°ºå¯¸</label>
                            <select id="size">
                                <option value="512x512">512Ã—512 (æ­£æ–¹å½¢)</option>
                                <option value="768x512">768Ã—512 (æ¨ªå‘)</option>
                                <option value="512x768">512Ã—768 (çºµå‘)</option>
                                <option value="1024x1024">1024Ã—1024 (é«˜æ¸…æ­£æ–¹å½¢)</option>
                                <option value="1152x896">1152Ã—896 (é«˜æ¸…æ¨ªå‘)</option>
                                <option value="896x1152">896Ã—1152 (é«˜æ¸…çºµå‘)</option>
                            </select>
                        </div>
                    </div>

                    <div class="advanced-params">
                        <h3>âš™ï¸ å¯é€‰å‚æ•°</h3>
                        <div class="param-row">
                            <div class="form-group">
                                <label for="steps">ç”Ÿæˆæ­¥æ•°</label>
                                <input type="number" id="steps" value="20" min="10" max="30">
                            </div>
                            <div class="form-group">
                                <label for="seed">éšæœºç§å­ (å¯é€‰)</label>
                                <input type="number" id="seed" placeholder="ç•™ç©ºä½¿ç”¨éšæœºç§å­">
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="generate-btn" id="generateBtn">
                        ğŸš€ å¼€å§‹ç”Ÿæˆ
                    </button>
                </form>
            </div>

            <!-- ç»“æœåŒºåŸŸ -->
            <div class="result-section">
                <h2>ğŸ–¼ï¸ ç”Ÿæˆç»“æœ</h2>
                
                <div id="statusCard" class="status-card" style="display: none;">
                    <div id="statusText">å‡†å¤‡ä¸­...</div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%;"></div>
                    </div>
                    <div id="errorMessage" class="error-message" style="display: none;"></div>
                </div>

                <div id="resultContainer" style="display: none;">
                    <img id="resultImage" class="result-image">
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="downloadImage()" class="generate-btn" style="width: auto; padding: 10px 20px;">
                            ğŸ’¾ ä¸‹è½½å›¾åƒ
                        </button>
                    </div>
                </div>
            </div>

            <!-- å†å²è®°å½•åŒºåŸŸ -->
            <div class="history-section">
                <h2>ğŸ“š ç”Ÿæˆå†å²</h2>
                <div id="historyContainer">
                    <p>æš‚æ— å†å²è®°å½•</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:9000/api';
        let currentTaskId = null;
        let pollInterval = null;

        // å›¾åƒé¢„è§ˆ
        document.getElementById('referenceImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
                
                // æ›´æ–°æ ‡ç­¾æ–‡æœ¬
                document.querySelector('.file-upload-label div').textContent = file.name;
            }
        });

        // è¡¨å•æäº¤
        document.getElementById('generateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const referenceImage = document.getElementById('referenceImage').files[0];
            const description = document.getElementById('description').value;
            const count = document.getElementById('count').value;
            const size = document.getElementById('size').value;
            const steps = document.getElementById('steps').value;
            const seed = document.getElementById('seed').value;
            
            if (!referenceImage || !description) {
                alert('è¯·é€‰æ‹©å‚è€ƒå›¾åƒå¹¶è¾“å…¥æè¿°');
                return;
            }
            
            formData.append('reference_image', referenceImage);
            formData.append('description', description);
            formData.append('count', count);
            formData.append('size', size);
            formData.append('steps', steps);
            if (seed) {
                formData.append('seed', seed);
            }
            
            try {
                // æ˜¾ç¤ºçŠ¶æ€å¡ç‰‡
                showStatus('æäº¤ä»»åŠ¡ä¸­...', 0);
                document.getElementById('generateBtn').disabled = true;
                document.getElementById('generateBtn').textContent = 'ç”Ÿæˆä¸­...';
                
                const response = await fetch(`${API_BASE}/generate-image`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                currentTaskId = result.task_id;
                
                // å¼€å§‹è½®è¯¢çŠ¶æ€
                startPolling();
                
            } catch (error) {
                console.error('Error:', error);
                showError('æäº¤ä»»åŠ¡å¤±è´¥: ' + error.message);
                resetForm();
            }
        });

        function showStatus(text, progress) {
            document.getElementById('statusCard').style.display = 'block';
            document.getElementById('statusText').textContent = text;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('resultContainer').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        function showResult(result) {
            document.getElementById('resultContainer').style.display = 'block';
            document.getElementById('statusCard').style.display = 'none';
            
            const resultImage = document.getElementById('resultImage');
            
            if (result.image_urls && result.image_urls.length > 1) {
                // å¤šä¸ªå›¾åƒï¼šæ˜¾ç¤ºç¬¬ä¸€ä¸ªå›¾åƒï¼Œå¹¶æ·»åŠ åˆ‡æ¢åŠŸèƒ½
                resultImage.src = result.image_urls[0];
                
                // åˆ›å»ºå›¾åƒåˆ‡æ¢æ§ä»¶
                let imageControls = document.getElementById('imageControls');
                if (!imageControls) {
                    imageControls = document.createElement('div');
                    imageControls.id = 'imageControls';
                    imageControls.style.cssText = 'margin-top: 10px; text-align: center;';
                    document.getElementById('resultContainer').appendChild(imageControls);
                }
                
                imageControls.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <span>å›¾åƒ 1 / ${result.count}</span>
                    </div>
                    <div>
                        <button onclick="showPrevImage()" style="margin-right: 10px;">â† ä¸Šä¸€å¼ </button>
                        <button onclick="showNextImage()">ä¸‹ä¸€å¼  â†’</button>
                    </div>
                    <div style="margin-top: 10px;">
                        <button onclick="downloadAllImages()">ğŸ“¥ ä¸‹è½½å…¨éƒ¨</button>
                    </div>
                `;
                
                // å­˜å‚¨å½“å‰ç»“æœæ•°æ®
                window.currentResult = result;
                window.currentImageIndex = 0;
            } else {
                // å•ä¸ªå›¾åƒï¼šä½¿ç”¨åŸæœ‰é€»è¾‘
                const imageUrl = result.image_urls ? result.image_urls[0] : result.image_url;
                resultImage.src = imageUrl;
                
                // ç§»é™¤å¤šå›¾åƒæ§ä»¶
                const imageControls = document.getElementById('imageControls');
                if (imageControls) {
                    imageControls.remove();
                }
            }
        }

        function resetForm() {
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateBtn').textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆ';
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        function startPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            
            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/task/${currentTaskId}`);
                    const status = await response.json();
                    
                    if (status.status === 'pending') {
                        showStatus('ä»»åŠ¡æ’é˜Ÿä¸­...', 10);
                    } else if (status.status === 'processing') {
                        showStatus('æ­£åœ¨ç”Ÿæˆå›¾åƒ...', status.progress || 50);
                    } else if (status.status === 'completed') {
                        showStatus('ç”Ÿæˆå®Œæˆ!', 100);
                        setTimeout(() => {
                            showResult(status.result);
                            resetForm();
                            loadHistory(); // åˆ·æ–°å†å²è®°å½•
                        }, 1000);
                    } else if (status.status === 'failed') {
                        showError('ç”Ÿæˆå¤±è´¥: ' + (status.error || 'æœªçŸ¥é”™è¯¯'));
                        resetForm();
                    }
                    
                } catch (error) {
                    console.error('Polling error:', error);
                    showError('æ£€æŸ¥çŠ¶æ€å¤±è´¥: ' + error.message);
                    resetForm();
                }
            }, 2000);
        }

        function downloadImage() {
            const imageUrl = document.getElementById('resultImage').src;
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = `generated_image_${Date.now()}.png`;
            link.click();
        }
        
        function showPrevImage() {
            if (window.currentResult && window.currentImageIndex > 0) {
                window.currentImageIndex--;
                document.getElementById('resultImage').src = window.currentResult.image_urls[window.currentImageIndex];
                updateImageCounter();
            }
        }
        
        function showNextImage() {
            if (window.currentResult && window.currentImageIndex < window.currentResult.image_urls.length - 1) {
                window.currentImageIndex++;
                document.getElementById('resultImage').src = window.currentResult.image_urls[window.currentImageIndex];
                updateImageCounter();
            }
        }
        
        function updateImageCounter() {
            const counter = document.querySelector('#imageControls span');
            if (counter) {
                counter.textContent = `å›¾åƒ ${window.currentImageIndex + 1} / ${window.currentResult.count}`;
            }
        }
        
        function downloadAllImages() {
            if (window.currentResult && window.currentResult.image_urls) {
                window.currentResult.image_urls.forEach((url, index) => {
                    setTimeout(() => {
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `generated_image_${Date.now()}_${index + 1}.png`;
                        link.click();
                    }, index * 500); // å»¶è¿Ÿä¸‹è½½é¿å…æµè§ˆå™¨é˜»æ­¢
                });
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch(`${API_BASE}/history`);
                const data = await response.json();
                
                const container = document.getElementById('historyContainer');
                
                if (data.tasks && data.tasks.length > 0) {
                    container.innerHTML = data.tasks.map(task => `
                        <div class="history-item">
                            <div>
                                <div><strong>${task.description.substring(0, 50)}...</strong></div>
                                <small>${new Date(task.created_at).toLocaleString()}</small>
                                <div>çŠ¶æ€: ${getStatusText(task.status)}</div>
                            </div>
                            ${task.result_url ? `<img src="${task.result_url}" onclick="viewImage('${task.result_url}')">` : ''}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p>æš‚æ— å†å²è®°å½•</p>';
                }
            } catch (error) {
                console.error('Load history error:', error);
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'ç­‰å¾…ä¸­',
                'processing': 'å¤„ç†ä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥'
            };
            return statusMap[status] || status;
        }

        function viewImage(url) {
            window.open(url, '_blank');
        }

        // é¡µé¢åŠ è½½æ—¶è·å–å†å²è®°å½•
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
        });
    </script>
</body>
</html>